sudo: required

services:
  - docker

language: rust

cache: cargo

rust:
  - stable
  - nightly

env:
  global:
    # CRATES_IO_TOKEN
    - secure: HCIhhVrX0hLJtnPGHzIaw60y4XDu9ZF6nHsDVqhWTukzM/J8jDoufVP70mm/dhTpIkrMHhs05/x9BRNqwHObuTW82SlyENs9714r9nljVD/qwy6I2gRbUPXY9p5CTeNeRrzkcaZa4nZ7lQ1R4GqlviH1bJfYqT0tO0wq+3LMvTdY2VCptfwUZZpfkQFw2F2uK4gFMnnJOiCHizbttdv7ZlSi75ngS+q+G0g6QAgUA4Xe5uo9KvNLJpNpQ4aQulyn4UuHBX+Nfqq1tq+UdxaLdXZOB7VWK/3BYnl9kSuFQMQoZ4DIGgYnURL39wsXmawkT7YIuhoHN4o3M7Z0Ay0lcTEq03ev9oMyxz4v/oQKpCBVUdbKL15IQsOrDynK3vh6MEqWyoyQfpQy+VhFlrY7wOrrkOhFXOsv2+lJzfodXVvlfKAwLuvASnbFV9l+z3+JA0L1IKWgiJXeIhsz6eSkkU/vReeNVIvwBN8Dk9HDrkeKJvFGkPZDNEsQhnrJ6jRHXq0sMSA6Y2RPYcup3uLzjrgdjB6NZvDjjNWrm+1J8Na28NzCy/O95eyn3fE5HVgfCSdDmwG7H4yQIUBAlflXLvXSEaK/8JGFXhsyG8pZEwQd70HlLWglxaIFOdpymr8oskymxFfGIz/ULKi9gcvuZrrec7JW1c/YEe2g9fWWsG4=
    # DOCKER_USERNAME
    - secure: xUTLNPYdWT5mVrgO0n6JMzHFYVynDe5OoJlOgO3CzG0Mg3bW6s4FulTYkspQgERtPAaYIq8mXfszWVW1Eenl3gdPFtG0WvFyzRXhdRDd8AYQIh9U5H39Ab92HduptWdEM374lL4zV1v6QR5gPl6ubp129egxZkh0gco8pj5QIt0PUeZ/LjpwbdK79hMhVXXBvNhKUL2ufIjUJhbK0SEVbbWdDv200/06OB57gGjPQgVVkk/i1QGSUNZrj/wlqH79kfC6VdpauMmhXUXNnC9xgokcVoKs6vh7JXK2t5oD0LzkvIsAbalQrGZtMZN7fPe4K609y49EjLL8KD12vlrAm1GbDpzACV7wakS6ITGdamuQHL3zA/DMUM6w1d8oPkDcw+8QDSdA3iiwV20Q5ig5enNE4CrifuaUbwUf+cZtDgF1mkuLvqyMG+pF3A/pMxBSfoEtNrR96bVxyVaQuzRWMMrTfDLWiNllMSu9XIL4s5b15xuIHqj+BB/WJkzhKPkeHG9ftIsLdBg8kTmyDUTNBeKY1JDWT+6Asc2HNfXfBsCrL64TXLWR7yUz5R5OW2YwT+GxMa8xY6czsVuhO1OqWwknyoJHWrQjGCu5NPD/HlQESE6uaAQHmInUGoQPsDjIwlt71xyEZlcCO6F2E8tlFuts1LkOaZ0+n26SkAkYlxs=
    # DOCKER_PASSWORD
    - secure: zWmC0Wolae9Z4tVqrQRy2vwOtPUgKTK9nac37cGBdBfjsGBAtQzb4mW02Zd6ByLmUfIhSTDgsxMHh5nGcDmAVBKkxZcp2zaYuAGfJmHSQhNGI21hiX/fkaWAWtXNQcebWrO/CRKXNLSfLLxr7/dlC4wkRS2yphvzMDVb1AkuvZ/cawmpN9z+yIWR0sAdTc0xGKb8CkUTGd38nxCAt6E6jUjk2NhzfoOzTyTOiW3C4BZpUnWE9PgPUTrTdZtxTQ4SlIdvE2Snd18vgrjVHkpdMsHzlqhEcECeYhnPSLHhstpCsulXNMPNtf+xPhS1PWGzlHxP7oGxvBUeJrvHfDxnVujnFFBGxAk/qJ8y+Jn/IuVdTwDyALMpXnDqAZAWGBVOUQwf/WzxkKRg6aiMBJ0sybGrU2YKZCFiIp1DHoNRGdE2mIMdReR7s1j99H0qOFtUnHIaRJP/e3A3OR8FreCDwslmK/6HJbTqvyfRRiPVfmw/ry8+ILQka0raO0p8Ly/1jsXV0O40DZl/fn/+vmSS/5KnGYzQhdfYlB77LHIEIelyTVjqJcIDGSG3yK8PKWX/LWA1bu0L4MXMgVqG+wrc2biMCGrSBNk57W4wBp+yTm5ZtF3CYFthBD8IG/JaOKlBw8ooRvUanUpSfHV1Q1lKMUH93zCKGDOb+NnOXru511s=
  matrix:
    - CRATE=vhdl_parser
    - CRATE=vhdl_ls

matrix:
  allow_failures:
    - rust: nightly
  fast_finish: true

install:
  - rustup component add clippy-preview
  - rustup component add rustfmt-preview

script:
  - cargo fmt --package $CRATE -- --check
  - cargo clippy --package $CRATE || true
  - cargo build --package $CRATE
  - cargo test --package $CRATE

before_deploy:
  - docker build -t kraigher/$CRATE:${TRAVIS_TAG:-latest} --build-arg RUST_VERSION=$TRAVIS_RUST_VERSION --build-arg CRATE=$CRATE .
   - echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin

deploy:
  # @TODO create tag after release
  - provider: script
    script:
      - cd $CRATE && cargo publish --token "${CRATES_IO_TOKEN}" || true
      - docker push kraigher/$CRATE:${TRAVIS_TAG:-latest}
    on:
      rust: stable
      branch: master
